# 腾讯云部署操作步骤

## 一、服务器准备

### 1.1 购买服务器
- 登录腾讯云控制台，购买轻量应用服务器
- 推荐配置：2核2G，Ubuntu 22.04 系统
- 记录服务器公网 IP（如：1.14.163.14）

### 1.2 开放防火墙端口
在腾讯云控制台 → 实例详情 → 防火墙，添加规则：
- 端口 **80**（HTTP，前端访问）
- 端口 **8080**（后端 API）
- 端口 **3306**（MySQL，如本地安装）

### 1.3 连接服务器
- 方式一：腾讯云控制台 → 实例列表 → 登录 → WebShell
- 方式二：SSH 工具连接

---

## 二、服务器环境安装

### 2.1 安装 JDK 17
```bash
sudo apt update
sudo apt install openjdk-17-jdk -y
java -version
```

### 2.2 安装 Nginx
```bash
sudo apt install nginx -y
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 2.3 安装 MySQL（可选，如使用本地数据库）
```bash
sudo apt install mysql-server -y
sudo systemctl start mysql
sudo systemctl enable mysql

# 设置 root 密码
sudo mysql
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '你的密码';
FLUSH PRIVILEGES;
EXIT;
```

---

## 三、数据库部署

### 3.1 方案一：使用 Railway MySQL（海外，有延迟）

1. 登录 Railway 控制台，创建 MySQL 服务
2. 获取连接信息：
   - Host: tramway.proxy.rlwy.net
   - Port: 30117
   - Database: railway
   - Username: root
   - Password: 你的密码

3. 导入数据库脚本：
```bash
mysql -h tramway.proxy.rlwy.net -u root -p --port 30117 --protocol=TCP railway < datasourse.sql
```

### 3.2 方案二：使用腾讯云本地 MySQL（推荐）

1. 创建数据库：
```bash
mysql -u root -p
CREATE DATABASE book_trading CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE book_trading;
SOURCE /path/to/datasourse.sql;
EXIT;
```

---

## 四、后端部署

### 4.1 修改配置文件
编辑 `application-tencent.yml`，配置数据库连接：
```yaml
spring:
  datasource:
    url: jdbc:mysql://tramway.proxy.rlwy.net:30117/railway?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=GMT%2B8&allowPublicKeyRetrieval=true
    username: root
    password: 你的数据库密码
```

### 4.2 本地打包
```bash
cd backgrond
mvn clean package -DskipTests
```
生成文件：`target/book-trading-1.0.0.jar`

### 4.3 上传 JAR 包
- 使用 WebShell 上传功能，上传到 `/opt/app/`
- 或使用 scp 命令：
```bash
scp book-trading-1.0.0.jar root@1.14.163.14:/opt/app/
```

### 4.4 启动后端服务
```bash
cd /opt/app

# 停止旧进程（如有）
pkill -f java

# 启动服务
nohup java -jar book-trading-1.0.0.jar --spring.profiles.active=tencent > app.log 2>&1 &

# 查看日志
tail -f app.log
```

### 4.5 验证后端
- 访问：http://1.14.163.14:8080/api/doc.html
- 看到 Swagger 文档页面即成功

---

## 五、前端部署

### 5.1 修改生产环境配置
编辑 `frontend/.env.production`：
```
VITE_API_BASE_URL=http://1.14.163.14/api
```

### 5.2 本地打包
```bash
cd frontend
npm run build
```
生成目录：`dist/`

### 5.3 上传前端文件
1. 将 `dist` 文件夹打包成 `dist.zip`
2. 上传到服务器 `/var/www/booktrading/`
3. 解压：
```bash
cd /var/www/booktrading
unzip dist.zip
mv dist/* .
rm -rf dist dist.zip
```

### 5.4 配置 Nginx
```bash
sudo tee /etc/nginx/sites-available/default > /dev/null << 'EOF'
server {
    listen 80;
    server_name 1.14.163.14;
    root /var/www/booktrading;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
EOF

# 测试配置
sudo nginx -t

# 重载 Nginx
sudo systemctl reload nginx
```

### 5.5 验证前端
- 访问：http://1.14.163.14
- 看到前端页面即成功

---

## 六、常用运维命令

### 6.1 后端管理
```bash
# 查看后端进程
ps aux | grep java

# 停止后端
pkill -f java

# 重启后端
cd /opt/app
nohup java -jar book-trading-1.0.0.jar --spring.profiles.active=tencent > app.log 2>&1 &

# 查看日志
tail -f /opt/app/app.log
```

### 6.2 Nginx 管理
```bash
# 启动
sudo systemctl start nginx

# 停止
sudo systemctl stop nginx

# 重启
sudo systemctl restart nginx

# 重载配置
sudo systemctl reload nginx

# 查看状态
sudo systemctl status nginx
```

### 6.3 MySQL 管理（本地安装时）
```bash
# 启动
sudo systemctl start mysql

# 停止
sudo systemctl stop mysql

# 登录
mysql -u root -p
```

---

## 七、项目访问地址

| 服务 | 地址 |
|------|------|
| 前端页面 | http://1.14.163.14 |
| 后端 API | http://1.14.163.14/api |
| Swagger 文档 | http://1.14.163.14:8080/api/doc.html |

---

## 八、常见问题

### Q1: 后端启动报端口占用
```bash
pkill -f java
# 等待 2 秒后重新启动
```

### Q2: 数据库连接失败
- 检查数据库地址、端口、密码是否正确
- 检查防火墙是否开放数据库端口
- 检查 JDBC URL 格式是否正确（必须以 `jdbc:mysql://` 开头）

### Q3: 前端页面空白
- 检查 Nginx 配置是否正确
- 检查 `/var/www/booktrading/` 目录下是否有 `index.html`
- 查看浏览器控制台错误信息

### Q4: 跨域错误
- 确保前端 `VITE_API_BASE_URL` 配置为 `http://IP/api`（不带端口）
- 确保 Nginx 代理配置正确

### Q5: 数据库查询慢
- 原因：腾讯云服务器（国内）连接 Railway MySQL（海外）有网络延迟
- 解决：将 MySQL 部署到腾讯云服务器本地
